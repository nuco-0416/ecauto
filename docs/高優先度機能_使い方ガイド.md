# 高優先度機能 使い方ガイド

**作成日**: 2025年11月20日

このドキュメントでは、新たに実装した2つの高優先度機能の使い方を説明します。

---

## 目次

1. [在庫切れ時の自動非公開機能](#1-在庫切れ時の自動非公開機能)
2. [価格同期スクリプト](#2-価格同期スクリプト)
3. [定期実行の設定（Windowsタスクスケジューラ）](#3-定期実行の設定)

---

## 1. 在庫切れ時の自動非公開機能

### 概要

Amazon在庫切れ時に全プラットフォーム（BASE）で商品を自動的に非公開にし、在庫復活時に再公開する機能です。

### ファイル場所

```
inventory/scripts/sync_stock_visibility.py
```

### 基本的な使い方

#### DRY RUNモード（テスト実行）

実際の更新は行わず、どの商品が更新されるかを確認します。

```bash
cd C:\Users\hiroo\Documents\GitHub\ecauto
./venv/Scripts/python.exe inventory/scripts/sync_stock_visibility.py --dry-run
```

#### 本番実行

実際にBASE APIで商品のvisibilityを更新します。

```bash
./venv/Scripts/python.exe inventory/scripts/sync_stock_visibility.py
```

### オプション

| オプション | 説明 | デフォルト値 |
|-----------|------|-------------|
| `--platform` | プラットフォーム名 | `base` |
| `--dry-run` | DRY RUNモード（実際の更新なし） | なし |

### 実行例

```bash
# DRY RUNで確認
./venv/Scripts/python.exe inventory/scripts/sync_stock_visibility.py --dry-run

# 本番実行
./venv/Scripts/python.exe inventory/scripts/sync_stock_visibility.py
```

### 出力例

```
======================================================================
在庫切れ時の自動非公開処理を開始
======================================================================
プラットフォーム: base
実行モード: 本番実行
開始時刻: 2025-11-20 14:30:00

アクティブアカウント数: 3件

--- アカウント: BASE本店 (base_account_1) ---
出品数: 150件
  [UPDATE] B0CB5G8NRV | public → hidden
    → 更新成功
  [UPDATE] B08XYZ1234 | hidden → public
    → 更新成功

--- アカウント: BASE別館 (base_account_2) ---
出品数: 200件
  [UPDATE] B09ABC5678 | public → hidden
    → 更新成功

======================================================================
処理結果サマリー
======================================================================
処理した商品数: 350件
  - 在庫あり: 320件
  - 在庫切れ: 30件

更新した商品数:
  - 非公開に変更: 25件
  - 公開に変更: 5件

エラー: 0件
======================================================================
終了時刻: 2025-11-20 14:35:00
```

### 動作の流れ

1. アクティブなBASEアカウントをすべて取得
2. 各アカウントの出品一覧を取得（status='listed'のみ）
3. 各出品について：
   - マスタDBから商品情報を取得
   - `amazon_in_stock`フィールドをチェック
   - 在庫切れ → `visibility='hidden'`に変更
   - 在庫あり → `visibility='public'`に変更
4. BASE APIで更新（変更が必要な場合のみ）
5. マスタDBのlistingsテーブルも更新

### 注意事項

- **レート制限**: 各API呼び出しの間に2秒の待機時間があります
- **対象**: `status='listed'`の出品のみ処理します
- **在庫情報の取得元**: マスタDBの`amazon_in_stock`フィールド、またはキャッシュ
- **推奨頻度**: 1時間に1回程度

---

## 2. 価格同期スクリプト

### 概要

キャッシュベースでAmazon価格を取得し、BASE出品の価格を自動同期します。SP-APIのレート制限を節約するため、キャッシュが古い場合のみSP-APIを呼び出します。

### ファイル場所

```
platforms/base/scripts/sync_prices.py
```

### 基本的な使い方

#### DRY RUNモード（テスト実行）

実際の更新は行わず、どの商品の価格が更新されるかを確認します。

```bash
cd C:\Users\hiroo\Documents\GitHub\ecauto
./venv/Scripts/python.exe platforms/base/scripts/sync_prices.py --dry-run
```

#### 本番実行

実際にBASE APIで商品価格を更新します。

```bash
./venv/Scripts/python.exe platforms/base/scripts/sync_prices.py
```

### オプション

| オプション | 説明 | デフォルト値 |
|-----------|------|-------------|
| `--markup-ratio` | 掛け率（Amazon価格に対する倍率） | `1.3`（30%増し） |
| `--dry-run` | DRY RUNモード（実際の更新なし） | なし |
| `--account` | 特定のアカウントIDのみ処理 | なし（全アカウント） |

### 実行例

```bash
# DRY RUNで確認（掛け率1.3）
./venv/Scripts/python.exe platforms/base/scripts/sync_prices.py --dry-run

# 本番実行（掛け率1.3）
./venv/Scripts/python.exe platforms/base/scripts/sync_prices.py

# 掛け率1.5で実行
./venv/Scripts/python.exe platforms/base/scripts/sync_prices.py --markup-ratio 1.5

# 特定アカウントのみ処理
./venv/Scripts/python.exe platforms/base/scripts/sync_prices.py --account base_account_1
```

### 出力例

```
======================================================================
価格同期処理を開始
======================================================================
掛け率: 1.3
最小価格差: ¥100
実行モード: 本番実行
開始時刻: 2025-11-20 15:00:00

アクティブアカウント数: 3件

--- アカウント: BASE本店 (base_account_1) ---
出品数: 150件
  [UPDATE] B0CB5G8NRV | ¥2,500 → ¥2,730 (差額: ¥230)
    Amazon価格: ¥2,100
    → 更新成功
  [UPDATE] B08XYZ1234 | ¥5,000 → ¥5,200 (差額: ¥200)
    Amazon価格: ¥4,000
    → 更新成功

--- アカウント: BASE別館 (base_account_2) ---
出品数: 200件
  [UPDATE] B09ABC5678 | ¥3,000 → ¥3,250 (差額: ¥250)
    Amazon価格: ¥2,500
    [SP-API] キャッシュミス: B09ABC5678 - SP-APIで取得中...
    → 更新成功

======================================================================
処理結果サマリー
======================================================================
処理した出品数: 350件

キャッシュ:
  - キャッシュヒット: 340件
  - キャッシュミス: 10件
  - ヒット率: 97.1%
  - SP-API呼び出し: 10件

価格更新:
  - 更新した商品: 45件
  - 更新不要: 305件

エラー: 0件
======================================================================
終了時刻: 2025-11-20 15:15:00
```

### 動作の流れ

1. アクティブなBASEアカウントをすべて取得
2. 各アカウントの出品一覧を取得（status='listed'のみ）
3. 各出品について：
   - **キャッシュから**Amazon価格を取得
   - キャッシュが期限切れ（24時間以上）の場合のみSP-APIを呼び出し
   - 販売価格を計算: `販売価格 = Amazon価格 × 掛け率`
   - 現在価格との差額が¥100以上の場合のみ更新
4. BASE APIで価格を更新
5. マスタDBのlistingsテーブルも更新

### 価格計算ロジック

```python
販売価格 = Amazon価格（円） × 掛け率

# 例：
# Amazon価格 = ¥2,000
# 掛け率 = 1.3
# 販売価格 = ¥2,000 × 1.3 = ¥2,600
```

### 最小価格差

価格差が**¥100未満**の場合は更新をスキップします。これにより、不要なAPI呼び出しを削減できます。

### 注意事項

- **レート制限**: 各API呼び出しの間に2秒の待機時間があります
- **キャッシュTTL**: 24時間（変更したい場合は`cache_manager.py`を編集）
- **SP-API節約**: キャッシュヒット率が高いほどSP-API呼び出しが少なくなります
- **推奨頻度**: 1日1回程度（深夜実行推奨）

---

## 3. 定期実行の設定

これらのスクリプトを定期的に実行するには、Windowsタスクスケジューラを使用します。

### 3.1 在庫切れ自動非公開（1時間ごと）

#### バッチファイルの作成

`C:\Users\hiroo\Documents\GitHub\ecauto\scheduled_tasks\sync_stock_visibility.bat`

```batch
@echo off
cd /d C:\Users\hiroo\Documents\GitHub\ecauto
venv\Scripts\python.exe inventory\scripts\sync_stock_visibility.py >> logs\sync_stock_visibility.log 2>&1
```

#### タスクスケジューラの設定

1. **タスクスケジューラを開く**
   - Windowsキー → 「タスクスケジューラ」で検索

2. **基本タスクの作成**
   - 名前: `EC Auto - 在庫切れ自動非公開`
   - 説明: `Amazon在庫切れ時にBASE商品を自動非公開`

3. **トリガー**
   - 繰り返し間隔: `1時間`
   - 継続時間: `無制限`
   - 開始時刻: `00:00:00`（深夜0時から開始）

4. **操作**
   - プログラム/スクリプト: `C:\Users\hiroo\Documents\GitHub\ecauto\scheduled_tasks\sync_stock_visibility.bat`

5. **条件**
   - コンピューターをAC電源で使用している場合のみ実行: オフ
   - タスクを実行するためにスリープ解除する: オン

### 3.2 価格同期（1日1回、深夜2時）

#### バッチファイルの作成

`C:\Users\hiroo\Documents\GitHub\ecauto\scheduled_tasks\sync_prices.bat`

```batch
@echo off
cd /d C:\Users\hiroo\Documents\GitHub\ecauto
venv\Scripts\python.exe platforms\base\scripts\sync_prices.py >> logs\sync_prices.log 2>&1
```

#### タスクスケジューラの設定

1. **基本タスクの作成**
   - 名前: `EC Auto - 価格同期`
   - 説明: `BASE商品の価格をAmazon価格に基づいて自動同期`

2. **トリガー**
   - 毎日: `02:00`（深夜2時）

3. **操作**
   - プログラム/スクリプト: `C:\Users\hiroo\Documents\GitHub\ecauto\scheduled_tasks\sync_prices.bat`

4. **条件**
   - コンピューターをAC電源で使用している場合のみ実行: オフ
   - タスクを実行するためにスリープ解除する: オン

### ログディレクトリの作成

```bash
cd C:\Users\hiroo\Documents\GitHub\ecauto
mkdir logs
mkdir scheduled_tasks
```

---

## トラブルシューティング

### エラー: アクティブなアカウントが見つかりません

**原因**: `platforms/base/accounts/account_config.json`に`"active": true`のアカウントがない

**解決策**: account_config.jsonを確認し、アカウントの`active`フィールドを`true`に設定してください。

```json
{
  "accounts": [
    {
      "id": "base_account_1",
      "name": "BASE本店",
      "active": true,  // ← これをtrueに
      ...
    }
  ]
}
```

### エラー: トークンが見つかりません

**原因**: `platforms/base/accounts/tokens/`にトークンファイルがない

**解決策**: 各アカウントの認証を行い、トークンを取得してください。

```bash
./venv/Scripts/python.exe platforms/base/scripts/get_all_tokens.py
```

### キャッシュヒット率が低い

**原因**: キャッシュが古いか、初回実行

**解決策**: 事前にキャッシュを更新してください。

```bash
./venv/Scripts/python.exe inventory/scripts/sync_amazon_data.py
```

### SP-API呼び出しが多すぎる

**原因**: キャッシュが期限切れ（24時間以上）

**解決策**:
1. キャッシュの有効期限を延長（`cache_manager.py`の`cache_ttl`を変更）
2. 価格同期の実行頻度を減らす（1日1回など）

---

## まとめ

### 推奨実行スケジュール

| スクリプト | 推奨頻度 | 推奨時間 | 理由 |
|-----------|---------|---------|------|
| 在庫切れ自動非公開 | 1時間ごと | 24時間 | 在庫切れ商品の早期非公開 |
| 価格同期 | 1日1回 | 深夜2時 | SP-API節約、Amazon価格変動への追従 |
| キャッシュ一括更新 | 1日1回 | 深夜3時 | 翌日の価格同期に備える |

### 実行順序（深夜バッチ）

1. **深夜2時**: 価格同期
2. **深夜3時**: キャッシュ一括更新（翌日分）
3. **1時間ごと**: 在庫切れ自動非公開

これにより、SP-APIのレート制限を効率的に使いながら、BASE出品の価格と在庫を最新状態に保つことができます。

---

**作成日**: 2025年11月20日
**対象バージョン**: EC Auto v1.0
**最終更新**: 2025年11月20日
