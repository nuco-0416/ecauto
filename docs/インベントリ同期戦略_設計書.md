# インベントリ同期戦略 設計書

**作成日**: 2025年11月20日
**対象環境**: 本番環境（数万件以上のSKU想定）
**目的**: SP-APIレート制限下での効率的かつ堅牢なインベントリ同期

---

## 目次

1. [要件定義](#要件定義)
2. [キャッシュ戦略](#キャッシュ戦略)
3. [インベントリ同期ワークフロー](#インベントリ同期ワークフロー)
4. [実装仕様](#実装仕様)
5. [運用フロー](#運用フロー)
6. [スケーリング戦略](#スケーリング戦略)

---

## 要件定義

### 前提条件

- **SKU数**: 数万件以上（目標: 10万件対応）
- **SP-APIレート制限**: 0.5リクエスト/秒（2秒に1回）
- **BASE出品数**: 1アカウントあたり最大数千件
- **更新頻度**:
  - 価格同期: 1日1回
  - 在庫同期: 1時間に1回

### 課題

1. **全件更新の非効率性**
   - 10万件 × 2秒 = 55.5時間（現実的でない）
   - SP-APIコストが膨大

2. **リアルタイム性の確保**
   - 在庫切れ商品の即座の非公開
   - 価格変動への迅速な対応

3. **レート制限とコストの最適化**
   - 必要最小限のSP-API呼び出し
   - キャッシュの効率的活用

---

## キャッシュ戦略

### 1. キャッシュ階層の定義

```
┌─────────────────────────────────────────────────────────┐
│ Layer 1: Master DB (SQLite)                             │
│ - products テーブル: 商品マスタ                          │
│ - 最終更新日時（last_fetched_at）を保持                 │
│ - 永続的（削除されない）                                 │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│ Layer 2: File Cache (JSON)                              │
│ - inventory/data/cache/amazon_products/{ASIN}.json      │
│ - TTL: 用途別に設定                                      │
│ - 高速アクセス                                           │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│ Layer 3: SP-API (オンデマンド)                          │
│ - キャッシュミス時のみ呼び出し                           │
│ - レート制限: 2秒/リクエスト                            │
└─────────────────────────────────────────────────────────┘
```

### 2. キャッシュTTL戦略（用途別）

| データ種別 | TTL | 理由 | 更新頻度 |
|-----------|-----|------|---------|
| **基本情報**（タイトル、説明、画像） | **7日** | ほぼ変更されない | 週1回 |
| **価格情報** | **24時間** | 日次で変動する可能性 | 1日1回 |
| **在庫情報** | **1時間** | リアルタイム性が重要 | 1時間ごと |
| **カテゴリ・ブランド** | **30日** | 変更されない | 月1回 |

### 3. キャッシュデータ構造

```json
{
  "asin": "B0CB5G8NRV",
  "title_ja": "商品名",
  "description_ja": "商品説明",
  "category": "Electronics",
  "brand": "ブランド名",
  "images": ["url1", "url2"],

  // 価格情報（TTL: 24時間）
  "price_jpy": 2500,
  "price_updated_at": "2025-11-20T10:00:00",

  // 在庫情報（TTL: 1時間）
  "in_stock": true,
  "stock_updated_at": "2025-11-20T18:00:00",

  // メタ情報
  "cached_at": "2025-11-20T18:00:00",
  "last_fetched_at": "2025-11-20T18:00:00"
}
```

---

## インベントリ同期ワークフロー

### 推奨ワークフロー（ユーザー提案ベース）

```
┌─────────────────────────────────────────────────────────┐
│ Step 1: キャッシュ検証・欠損確認                          │
│ - 更新対象ASINのキャッシュを確認                         │
│ - 欠損データ（価格、在庫）を特定                         │
│ - 期限切れキャッシュを特定                               │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│ Step 2: 差分データの補完（欠損のみ）                     │
│ - 欠損ASINのみSP-APIで取得                              │
│ - レート制限を考慮して順次取得                           │
│ - キャッシュとMaster DBを更新                           │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│ Step 3: 価格・在庫同期処理                               │
│ - キャッシュから価格・在庫情報を取得                     │
│ - BASE APIで商品を更新（変更があるもののみ）            │
│ - レート制限を考慮（2秒間隔）                           │
└─────────────────────────────────────────────────────────┘
```

### 具体的な実行コマンド

```bash
# 統合スクリプト（推奨）
./venv/Scripts/python.exe inventory/scripts/sync_inventory.py

# または個別実行
./venv/Scripts/python.exe inventory/scripts/validate_and_fill_cache.py  # Step 1-2
./venv/Scripts/python.exe platforms/base/scripts/sync_prices.py         # Step 3（価格）
./venv/Scripts/python.exe inventory/scripts/sync_stock_visibility.py    # Step 3（在庫）
```

---

## 実装仕様

### 1. キャッシュ検証・補完スクリプト

**ファイル**: `inventory/scripts/validate_and_fill_cache.py`

**機能**:
- 更新対象ASINのキャッシュを検証
- 欠損データ・期限切れデータを特定
- SP-APIで差分データを取得（欠損のみ）
- バッチ処理でレート制限を遵守

**実行例**:
```bash
# 全出品のキャッシュを検証
./venv/Scripts/python.exe inventory/scripts/validate_and_fill_cache.py

# 特定プラットフォームのみ
./venv/Scripts/python.exe inventory/scripts/validate_and_fill_cache.py --platform base

# DRY RUNモード
./venv/Scripts/python.exe inventory/scripts/validate_and_fill_cache.py --dry-run
```

**処理フロー**:
```python
def validate_and_fill_cache():
    # 1. 更新対象ASINを取得
    listings = master_db.get_listings(platform='base', status='listed')
    asins = [l['asin'] for l in listings]

    # 2. キャッシュ検証
    missing_asins = []
    expired_asins = []

    for asin in asins:
        cache_data = cache.get_product(asin)

        if not cache_data:
            missing_asins.append(asin)  # キャッシュなし
            continue

        # 価格情報のTTLチェック（24時間）
        if is_expired(cache_data, 'price_updated_at', ttl=86400):
            expired_asins.append(asin)

        # 在庫情報のTTLチェック（1時間）
        if is_expired(cache_data, 'stock_updated_at', ttl=3600):
            expired_asins.append(asin)

    # 3. 差分データを取得（欠損・期限切れのみ）
    need_update_asins = list(set(missing_asins + expired_asins))

    print(f"キャッシュ検証結果:")
    print(f"  - 全ASIN数: {len(asins)}")
    print(f"  - キャッシュなし: {len(missing_asins)}")
    print(f"  - 期限切れ: {len(expired_asins)}")
    print(f"  - 更新が必要: {len(need_update_asins)}")

    if need_update_asins:
        print(f"\nSP-APIで{len(need_update_asins)}件を取得します...")
        fetch_from_sp_api(need_update_asins)
    else:
        print("\n全てのキャッシュが最新です。更新は不要です。")
```

### 2. 統合同期スクリプト

**ファイル**: `inventory/scripts/sync_inventory.py`

**機能**:
- Step 1-3を一括実行
- エラーハンドリングとリトライ
- 実行結果のサマリー表示

**実行例**:
```bash
# 統合同期（価格・在庫両方）
./venv/Scripts/python.exe inventory/scripts/sync_inventory.py

# 価格のみ
./venv/Scripts/python.exe inventory/scripts/sync_inventory.py --price-only

# 在庫のみ
./venv/Scripts/python.exe inventory/scripts/sync_inventory.py --stock-only
```

### 3. 増分更新の最適化

**変更検知ロジック**:
```python
def needs_update(current_price, cached_price, threshold=100):
    """価格差が閾値以上の場合のみ更新"""
    return abs(current_price - cached_price) >= threshold

def needs_visibility_update(current_visibility, cached_stock):
    """在庫状況とvisibilityが不一致の場合のみ更新"""
    expected_visibility = 'public' if cached_stock else 'hidden'
    return current_visibility != expected_visibility
```

---

## 運用フロー

### 日次運用（推奨スケジュール）

```
深夜2:00 - 価格同期
├─ Step 1: キャッシュ検証（価格TTL: 24時間）
├─ Step 2: 差分データ補完（欠損のみSP-API）
└─ Step 3: BASE価格更新（変更があるもののみ）

毎時0分 - 在庫同期
├─ Step 1: キャッシュ検証（在庫TTL: 1時間）
├─ Step 2: 差分データ補完（欠損のみSP-API）
└─ Step 3: BASE在庫状態更新（変更があるもののみ）
```

### タスクスケジューラ設定例

```batch
# 価格同期（1日1回、深夜2時）
名前: EC Auto - 価格同期
トリガー: 毎日 02:00
コマンド: C:\Users\hiroo\Documents\GitHub\ecauto\venv\Scripts\python.exe
引数: inventory\scripts\sync_inventory.py --price-only
作業ディレクトリ: C:\Users\hiroo\Documents\GitHub\ecauto

# 在庫同期（1時間ごと）
名前: EC Auto - 在庫同期
トリガー: 1時間ごと
コマンド: C:\Users\hiroo\Documents\GitHub\ecauto\venv\Scripts\python.exe
引数: inventory\scripts\sync_inventory.py --stock-only
作業ディレクトリ: C:\Users\hiroo\Documents\GitHub\ecauto
```

---

## スケーリング戦略

### 1. 優先度ベースの更新

**優先度の定義**:
```python
# 高優先度: 直近7日間で売上がある商品
priority_high = """
    SELECT asin FROM listings
    WHERE last_sold_at >= date('now', '-7 days')
"""

# 中優先度: 直近30日間で閲覧がある商品
priority_medium = """
    SELECT asin FROM listings
    WHERE last_viewed_at >= date('now', '-30 days')
"""

# 低優先度: その他
priority_low = """
    SELECT asin FROM listings
    WHERE asin NOT IN (priority_high UNION priority_medium)
"""
```

**更新頻度の調整**:
- 高優先度: 1時間ごと
- 中優先度: 6時間ごと
- 低優先度: 24時間ごと

### 2. バッチ処理の分散

**時間帯別の分散**:
```python
# 10万件を24時間で分散して更新
total_asins = 100000
batch_size = 100  # 1バッチあたり100件
batches_per_hour = total_asins / 24 / batch_size  # 約42バッチ/時間

# 1バッチの実行時間: 100件 × 2秒 = 200秒（約3.3分）
# 1時間あたり: 42バッチ × 3.3分 = 139分（OK: 60分以内に調整可能）
```

**実装例**:
```python
def distributed_update(asins, batch_size=100):
    """ASINリストを時間帯別に分散して更新"""
    total_batches = len(asins) // batch_size
    batch_id = get_current_batch_id()  # 時刻ベースでバッチIDを決定

    start_idx = batch_id * batch_size
    end_idx = start_idx + batch_size

    current_batch = asins[start_idx:end_idx]

    print(f"バッチ {batch_id}/{total_batches} を処理中...")
    process_batch(current_batch)
```

### 3. 並列処理（将来の拡張）

**マルチスレッド処理**:
```python
from concurrent.futures import ThreadPoolExecutor

def parallel_update(asins, max_workers=5):
    """複数アカウントを並列処理"""
    accounts = get_active_accounts()

    with ThreadPoolExecutor(max_workers=len(accounts)) as executor:
        futures = []
        for account in accounts:
            account_asins = filter_by_account(asins, account)
            future = executor.submit(update_account, account, account_asins)
            futures.append(future)

        for future in futures:
            future.result()  # 完了を待機
```

---

## パフォーマンス試算

### ケース1: 初回実行（全件キャッシュなし）

- **ASIN数**: 10,000件
- **SP-API呼び出し**: 10,000回
- **所要時間**: 10,000 × 2秒 = 20,000秒（約5.5時間）
- **対策**: 初回のみ深夜バッチで実行、以降は差分更新

### ケース2: 日次運用（差分更新）

- **ASIN数**: 10,000件
- **期限切れ**: 約10%（1,000件/日）※価格TTL: 24時間
- **SP-API呼び出し**: 1,000回
- **所要時間**: 1,000 × 2秒 = 2,000秒（約33分）
- **評価**: ✅ 実用的

### ケース3: 在庫同期（1時間ごと）

- **ASIN数**: 10,000件
- **期限切れ**: 約10%（1,000件/時間）※在庫TTL: 1時間
- **SP-API呼び出し**: 1,000回
- **所要時間**: 1,000 × 2秒 = 2,000秒（約33分）
- **評価**: ✅ 実用的

---

## モニタリングとアラート

### 1. ログファイル

```
logs/
├── sync_inventory_20251120.log       # 統合同期ログ
├── cache_validation_20251120.log     # キャッシュ検証ログ
└── sp_api_calls_20251120.log         # SP-API呼び出しログ
```

### 2. メトリクス収集

```python
metrics = {
    'total_asins': 10000,
    'cache_hits': 9500,
    'cache_misses': 500,
    'sp_api_calls': 500,
    'base_api_updates': 200,
    'errors': 5,
    'execution_time_seconds': 1800
}
```

### 3. アラート条件

- SP-APIエラー率が10%を超えた場合
- BASE APIエラー率が5%を超えた場合
- キャッシュヒット率が80%を下回った場合
- 実行時間が予定の2倍を超えた場合

---

## まとめ

### ベストプラクティス

1. **差分更新優先**
   - 全件更新は初回のみ
   - 日次は変更があるもののみ更新

2. **キャッシュの積極活用**
   - 用途別にTTLを最適化
   - Master DBとFile Cacheの2層構造

3. **レート制限の遵守**
   - SP-API: 2秒間隔
   - BASE API: 2秒間隔

4. **優先度ベースの更新**
   - 売れ筋商品を優先
   - 低優先度商品は更新頻度を下げる

5. **エラーハンドリング**
   - リトライ機能（最大3回）
   - エラーログの詳細記録

### 推奨実装順序

1. **Phase 1**: キャッシュ検証・補完スクリプト
2. **Phase 2**: 統合同期スクリプト
3. **Phase 3**: タスクスケジューラ設定
4. **Phase 4**: モニタリング機能
5. **Phase 5**: 優先度ベース更新

---

**作成者**: Claude (Anthropic AI)
**対象バージョン**: EC Auto v1.0
**最終更新**: 2025年11月20日
