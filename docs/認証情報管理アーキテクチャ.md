# 認証情報管理アーキテクチャ

**作成日**: 2025年11月20日
**最終更新**: 2025年11月20日

このドキュメントでは、EC Autoシステムにおける各プラットフォームの認証情報管理方法を説明します。

---

## 目次

1. [全体アーキテクチャ](#全体アーキテクチャ)
2. [Amazon SP-API認証情報](#amazon-sp-api認証情報)
3. [BASE API認証情報](#base-api認証情報)
4. [eBay API認証情報](#ebay-api認証情報)
5. [.envファイルの役割](#envファイルの役割)
6. [認証情報の追加・更新手順](#認証情報の追加更新手順)

---

## 全体アーキテクチャ

```
ecauto/  (スタンドアロン)
│
├── .env                                    # 環境変数（Amazon SP-API認証情報）
├── .env.example                            # .envのテンプレート
│
├── integrations/
│   └── amazon/
│       └── config.py                       # Amazon SP-API認証情報の統一管理
│
└── platforms/
    ├── base/
    │   └── accounts/
    │       ├── account_config.json         # BASEアカウント設定
    │       └── tokens/                     # BASEトークン（アカウント別）
    │           ├── base_account_1_token.json
    │           └── base_account_2_token.json
    │
    ├── ebay/                               # eBay（Phase 5で実装予定）
    └── yahoo_auction/                      # Yahoo!オークション（Phase 5で実装予定）
```

**注**: このシステムは完全にスタンドアロンです。外部システムへの依存はありません。

---

## Amazon SP-API認証情報

### 管理方法

**統一モジュール**: `integrations/amazon/config.py`

### 認証情報の読み込み

```python
from integrations.amazon.config import SP_API_CREDENTIALS
from integrations.amazon.sp_api_client import AmazonSPAPIClient

# 使用例
sp_client = AmazonSPAPIClient(SP_API_CREDENTIALS)
```

#### 読み込み元

**.envファイル**（スタンドアロン）
   - 場所: `C:\Users\hiroo\Documents\GitHub\ecauto\.env`
   - 対応する変数名（2パターン）:
     - **優先**: `REFRESH_TOKEN`, `LWA_APP_ID`, `LWA_CLIENT_SECRET`
     - **代替**: `SP_API_REFRESH_TOKEN`, `SP_API_LWA_APP_ID`, `SP_API_LWA_CLIENT_SECRET`

#### .env形式（推奨）

```env
# Amazon SP-API設定
REFRESH_TOKEN="Atzr|your_refresh_token_here"
LWA_APP_ID="amzn1.application-oa2-client.your_app_id_here"
LWA_CLIENT_SECRET="amzn1.oa2-cs.v1.your_client_secret_here"
```

### 使用しているスクリプト

- [inventory/scripts/sync_amazon_data.py](inventory/scripts/sync_amazon_data.py) - Amazon商品情報の一括取得
- [inventory/scripts/add_new_products.py](inventory/scripts/add_new_products.py) - 新規商品の追加
- [platforms/base/scripts/sync_prices.py](platforms/base/scripts/sync_prices.py) - 価格同期

### 必要な認証情報

| キー | 説明 | 取得方法 |
|-----|------|---------|
| `refresh_token` | リフレッシュトークン | Amazon Seller Centralで取得 |
| `lwa_app_id` | LWA App ID（クライアントID） | Amazon Developer Consoleで取得 |
| `lwa_client_secret` | LWA Client Secret | Amazon Developer Consoleで取得 |

### レート制限

- **制限**: 0.5リクエスト/秒（2秒に1回）
- **実装**: `sp_api_client.py`で自動待機
- **推奨**: キャッシュを活用してSP-API呼び出しを最小化

---

## BASE API認証情報

### 管理方法

**複数アカウント対応**: JSONファイル + トークンディレクトリ

### ディレクトリ構造

```
platforms/base/accounts/
├── account_config.json          # アカウント設定（認証情報を含む）
└── tokens/                      # アカウント別トークン（自動更新）
    ├── base_account_1_token.json
    ├── base_account_2_token.json
    └── base_account_3_token.json
```

### account_config.json の形式

```json
{
  "accounts": [
    {
      "id": "base_account_1",
      "name": "森のBAZAAR",
      "description": "エレクトロニクス・おもちゃ",
      "active": true,
      "daily_upload_limit": 1000,
      "rate_limit_per_hour": 50,
      "credentials": {
        "client_id": "ea27d8083e10fa4ac548f7f1a24442ba",
        "client_secret": "a202baccfedce01e41a3d40e403f1030",
        "redirect_uri": "http://localhost:8080/callback"
      }
    }
  ]
}
```

### トークンの自動更新

BASE APIのアクセストークンは**自動的に更新**されます。

- **管理**: `platforms/base/accounts/manager.py` の `AccountManager`
- **自動更新メソッド**: `get_token_with_auto_refresh(account_id)`
- **トークンファイル**: `tokens/{account_id}_token.json`

#### トークンファイルの形式

```json
{
  "access_token": "eyJ0eXAiOiJKV1QiLCJhbGci...",
  "refresh_token": "def50200a1b2c3d4e5f6...",
  "expires_in": 3600,
  "token_type": "Bearer",
  "created_at": 1700000000
}
```

### 使用例

```python
from platforms.base.accounts.manager import AccountManager
from platforms.base.core.api_client import BaseAPIClient

# アカウントマネージャー
manager = AccountManager()

# トークンの自動更新付きAPIクライアント
client = BaseAPIClient(
    account_id='base_account_1',
    account_manager=manager
)

# API呼び出し（トークンが期限切れなら自動更新）
result = client.create_item({...})
```

### レート制限

- **制限**: 2秒間隔（30リクエスト/分）
- **実装**: `api_client.py`で自動待機
- **日次制限**: 1アカウントあたり1000件/日

---

## eBay API認証情報

### 現状

**.envファイルに記載あり**（未実装）

### .envファイルの設定

```env
# 本番環境
EBAY_PROD_APP_ID=HirooOgu-pythonap-PRD-0a3581975-2858695a
EBAY_PROD_CERT_ID=PRD-a3581975cb3d-f11a-43d8-9985-a68c
EBAY_PROD_REDIRECT_URI=https://www.example.com/callback
```

### 将来の実装予定

Phase 5（他プラットフォーム統合）で実装予定。

- 場所: `platforms/ebay/`
- 管理方法: BASEと同様のJSONベース管理を想定

---

## .envファイルの役割

### 場所

```
C:\Users\hiroo\Documents\GitHub\ecauto\.env
```

### 役割

1. **Amazon SP-API認証情報の管理**（必須）
   - スタンドアロンシステムの認証情報を管理
   - すべてのAmazon SP-API関連スクリプトが使用

2. **環境変数の集約**
   - Amazon SP-API（使用中）
   - BASE API（参考情報として記載、実際は account_config.json を使用）
   - eBay API（Phase 5で使用予定）

3. **新しい環境での簡単なセットアップ**
   - `.env.example`をコピーして`.env`を作成
   - 認証情報を記入するだけで動作

### 現在の.env内容

```env
# Amazon SP-API設定
REFRESH_TOKEN = "Atzr|..."
LWA_APP_ID = "amzn1.application-oa2-client..."
LWA_CLIENT_SECRET = "amzn1.oa2-cs.v1..."

# BASE API設定
BASE_CLIENT_ID=ea27d8083e10fa4ac548f7f1a24442ba
BASE_CLIENT_SECRET=a202baccfedce01e41a3d40e403f1030
BASE_REDIRECT_URI=http://localhost:8080/callback

# eBay API設定（本番環境）
EBAY_PROD_APP_ID=HirooOgu-pythonap-PRD-0a3581975-2858695a
EBAY_PROD_CERT_ID=PRD-a3581975cb3d-f11a-43d8-9985-a68c
EBAY_PROD_REDIRECT_URI=https://www.example.com/callback
```

### 注意事項

- **.gitignoreに追加済み**: .envファイルはGitにコミットされません
- **セキュリティ**: 認証情報を含むため、外部に公開しないこと
- **BASE API**: 現在は`account_config.json`を優先的に使用

---

## 認証情報の追加・更新手順

### 1. Amazon SP-API認証情報の更新

#### .envファイルを編集

```bash
# .envファイルを開く
notepad C:\Users\hiroo\Documents\GitHub\ecauto\.env
```

```env
# 以下の3つの変数を更新
REFRESH_TOKEN="新しいトークン"
LWA_APP_ID="新しいApp ID"
LWA_CLIENT_SECRET="新しいClient Secret"
```

#### 初回セットアップの場合

```bash
# .env.exampleをコピーして.envを作成
cd C:\Users\hiroo\Documents\GitHub\ecauto
copy .env.example .env

# .envファイルを編集して実際の認証情報を記入
notepad .env
```

#### 確認方法

```bash
cd C:\Users\hiroo\Documents\GitHub\ecauto
./venv/Scripts/python.exe -c "from integrations.amazon.config import SP_API_CREDENTIALS; print(SP_API_CREDENTIALS)"
```

**期待される出力:**
```
[INFO] SP-API認証情報: .envファイルから読み込み成功
{'refresh_token': 'Atzr|...', 'lwa_app_id': 'amzn1...', 'lwa_client_secret': 'amzn1...'}
```

### 2. BASEアカウントの追加

#### ステップ1: account_config.jsonに追加

```json
{
  "accounts": [
    {
      "id": "base_account_3",
      "name": "新規アカウント名",
      "description": "説明",
      "active": true,
      "daily_upload_limit": 1000,
      "rate_limit_per_hour": 50,
      "credentials": {
        "client_id": "クライアントID",
        "client_secret": "クライアントシークレット",
        "redirect_uri": "http://localhost:8080/callback"
      }
    }
  ]
}
```

#### ステップ2: OAuth認証を実行

```bash
./venv/Scripts/python.exe platforms/base/scripts/get_authorization_code.py base_account_3
```

ブラウザが開き、BASEにログインして認証します。

#### ステップ3: トークンの確認

```bash
./venv/Scripts/python.exe platforms/base/scripts/check_token_status.py
```

### 3. eBay認証情報の追加（将来）

現在は未実装。Phase 5で実装予定。

---

## トラブルシューティング

### Amazon SP-API認証情報が読み込めない

**症状**:
```
[ERROR] .envファイルが見つかりません
```
または
```
[ERROR] .envファイルに必要な認証情報が不足しています
```

**原因**:
1. .envファイルが存在しない
2. .envファイルに認証情報が記載されていない
3. 変数名が間違っている

**解決策**:

1. **.envファイルが存在しない場合:**
   ```bash
   cd C:\Users\hiroo\Documents\GitHub\ecauto
   copy .env.example .env
   notepad .env  # 実際の認証情報を記入
   ```

2. **.envファイルを確認:**
   ```bash
   notepad .env
   ```
   以下の変数が設定されているか確認:
   - `REFRESH_TOKEN` (または `SP_API_REFRESH_TOKEN`)
   - `LWA_APP_ID` (または `SP_API_LWA_APP_ID`)
   - `LWA_CLIENT_SECRET` (または `SP_API_LWA_CLIENT_SECRET`)

3. **変数名を確認:**
   - ✅ 正しい: `REFRESH_TOKEN="Atzr|..."`
   - ❌ 間違い: `SP_API_REFRESH_TOKEN="Atzr|..."`（動作するが非推奨）

### BASEトークンが期限切れ

**症状**:
```
[ERROR] トークン更新失敗: base_account_1
```

**原因**:
- リフレッシュトークンが無効
- OAuth認証がやり直し必要

**解決策**:
```bash
# 再認証
./venv/Scripts/python.exe platforms/base/scripts/get_authorization_code.py base_account_1
```

### SP-APIレート制限エラー

**症状**:
```
QuotaExceeded: You exceeded your quota for the requested resource.
```

**原因**:
- SP-APIの呼び出し頻度が高すぎる

**解決策**:
1. キャッシュを活用: 事前に`sync_amazon_data.py`でキャッシュ更新
2. 呼び出し間隔を調整: `sp_api_client.py`の`min_interval`を増やす
3. バッチ処理の間隔を空ける

---

## まとめ

### 認証情報管理の原則

1. **Amazon SP-API**: `.env`ファイル → `integrations/amazon/config.py`を経由して統一管理
2. **BASE API**: JSONファイル + トークン自動更新で管理
3. **スタンドアロン**: 外部システムへの依存なし
4. **セキュリティ**: 認証情報は.gitignoreで保護

### 認証情報フロー

```
.envファイル（Amazon SP-API認証情報）
  ↓
integrations/amazon/config.py（統一モジュール）
  ↓
各スクリプト（sync_prices.py, sync_amazon_data.py等）
```

### セットアップフロー（新しい環境）

```
1. リポジトリをクローン
   ↓
2. .env.exampleを.envにコピー
   ↓
3. .envに実際の認証情報を記入
   ↓
4. 完了！スタンドアロンで動作
```

### 参考リンク

- [Amazon SP-API ドキュメント](https://developer-docs.amazon.com/sp-api/)
- [BASE API ドキュメント](https://developers.thebase.in/)
- [進捗確認レポート_20251120.md](進捗確認レポート_20251120.md)

---

**作成者**: Claude (Anthropic AI)
**対象バージョン**: EC Auto v1.0
**最終更新**: 2025年11月20日
