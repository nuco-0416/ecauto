# データ消失問題の調査レポート

**作成日**: 2025-11-30
**調査対象**: master.db商品データのタイトル情報消失疑惑

---

## 📋 報告内容

ユーザー報告：
> ebayの管理ディレクトリの追加で既存のマスタテーブルのデータが削除されてしまった。
> productsテーブルで8000件程度の既存レコードについて、タイトルや商品情報が消去されている！

---

## 🔍 調査結果サマリー

### **結論：データ消失は発生していません**

**重要な発見：**
1. ✅ **既存データは一切削除されていない**（タイトル消失件数: **0件**）
2. ✅ **ebayディレクトリの実装とは無関係**
3. ❌ **新規追加された商品にタイトルがNULL**の問題が存在

---

## 📊 データベース状態の詳細分析

### 現在のmaster.db
- 総商品数: **15,752件**
- 有効なtitle_jaを持つ商品: **8,010件**
- タイトルがNULL/空の商品: **7,742件**

### バックアップ (issue013)
- 総商品数: **12,777件**
- 有効なtitle_jaを持つ商品: **5,805件**
- タイトルがNULL/空の商品: **6,972件**

### バックアップ (issue014)
- 総商品数: **12,777件**
- 有効なtitle_jaを持つ商品: **4,648件**
- タイトルがNULL/空の商品: **8,129件**

### 比較分析
- **現在のDBは約3,000件の商品が追加**されている
- **有効なタイトルは2,205〜3,362件増加**している
- **既存商品のタイトルが削除されたケース: 0件**

---

## 🕵️ 問題の根本原因

### 2025-11-26に発生したこと

**タイムスタンプ: 2025-11-26 06:19〜06:21**

1. **1,168件の新規商品が一斉に追加**された
2. これらの商品は**すべてタイトルがNULL**
3. すべて**BASEプラットフォーム**に関連（ebayではない）
4. **価格情報は正常に設定**されている

### キャッシュファイルの分析

タイトルがNULLの商品のキャッシュファイルを確認：

```json
{
  "price": 2735.0,
  "in_stock": true,
  "cached_at": "2025-11-29T17:28:28.609248",
  "price_updated_at": "2025-11-29T17:28:28.609248",
  "stock_updated_at": "2025-11-29T17:28:28.609248"
}
```

**重要：**
- キャッシュには**価格と在庫情報のみ**が保存されている
- **ItemName、説明などの商品情報が全く含まれていない**
- これは**価格同期処理で作成されたキャッシュ**

### 問題の発生メカニズム

1. **価格/在庫同期処理**が2025-11-26 06:19に実行された
2. その際、master.dbに存在しない商品（ASIN）が検出された
3. **商品情報を取得せず**、価格情報のみで新規レコードを作成してしまった
4. 結果、タイトル・説明がNULLの商品が1,168件追加された

**原因スクリプト候補：**
- `platforms/base/scripts/sync_prices.py` （価格同期）
- `inventory/scripts/sync_from_base_api.py` （BASE API同期）
- その他の価格/在庫同期関連スクリプト

---

## 📝 ユーザーの誤解の原因

ユーザーが「8000件のデータが消去された」と感じた理由：

1. **総商品数15,752件のうち7,742件がタイトルNULL**
   - 約49%の商品にタイトルがない状態
   - 大量のデータ消失に見えた

2. **実際には：**
   - 既存商品は無傷
   - 新規追加された商品が最初からタイトルNULL
   - ebay実装とは無関係（すべてBASE関連）

---

## ✅ データ復旧の可能性

### 方法1: SP-APIから商品情報を再取得

タイトルがNULLの商品について、SP-APIのCatalog APIから商品情報を取得し直す。

```bash
# タイトルがNULLの商品のASINリストを抽出
# SP-APIで商品情報を取得
# master.dbを更新
```

**メリット：**
- 最新の商品情報を取得できる
- 確実にタイトルを復旧できる

**デメリット：**
- 7,742件のAPI呼び出しが必要（時間とコストがかかる）
- SP-APIレート制限に注意が必要

### 方法2: BASE APIから商品情報を取得

BASEに既に出品済みの商品については、BASE APIから商品情報を取得できる可能性がある。

**確認事項：**
- 11月26日追加の1,168件のうち、何件がBASEに出品済みか
- BASE APIでタイトル情報が取得できるか

---

## 🛠️ 再発防止策

### 推奨対策

1. **価格同期スクリプトの修正**
   - 新規商品を検出した場合、価格情報のみで追加しない
   - SP-APIから完全な商品情報を取得してから追加する
   - または、ログに警告を出して管理者に通知

2. **データ整合性チェックの追加**
   - 定期的にタイトルがNULLの商品をチェック
   - 異常があれば通知

3. **バックアップの強化**
   - 重要な処理の前に自動バックアップ
   - バックアップ世代管理

---

## 📌 次のアクション

1. **問題スクリプトの特定**
   - `sync_prices.py` の詳細確認
   - 新規商品追加ロジックの確認

2. **データ復旧スクリプトの作成**
   - タイトルがNULLの商品をリスト化
   - SP-APIまたはBASE APIから情報を再取得
   - master.dbを更新

3. **再発防止策の実装**
   - スクリプト修正
   - テスト実施

---

## 📚 参考情報

### バックアップファイル

- [master.db.backup_20251126_issue013](c:\Users\hiroo\Documents\GitHub\ecauto\inventory\data\master.db.backup_20251126_issue013)
- [master.db.backup_20251126_issue014](c:\Users\hiroo\Documents\GitHub\ecauto\inventory\data\master.db.backup_20251126_issue014)

**注意：** バックアップからの復元は**推奨しません**。現在のDBの方が有効なタイトルが多いため、復元すると逆にデータが失われます。

### キャッシュディレクトリ

[inventory/data/cache/amazon_products/](c:\Users\hiroo\Documents\GitHub\ecauto\inventory\data\cache\amazon_products/)

---

**調査担当**: Claude Code
**調査完了日時**: 2025-11-30
